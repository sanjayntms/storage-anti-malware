# Deploying with quickstart script

> **Important!** The quickstart script is NOT secure, outputs secrets and is meant FOR TESTING ONLY!

The quickstart deployment script ([`QuickDeploy.ps1`](../QuickDeploy.ps1)) deploys the entire storage anti-malware solution including the required base infrastructure. The resources created are:

* Application Insights
* Log Analytics
* Key Vault
* Storage account (Data Lake Gen2)
* Container registry
* Azure Container Instances
* Azure Function app with its own storage account and app service plan

## Prerequisites

* Azure subscription with privileges to create and modify resources
* [PowerShell](https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell?view=powershell-7.1) environment with:
  * [Azure CLI](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli) installed
  * [.NET Core](https://dotnet.microsoft.com/download/dotnet-core) installed
  * [Docker (desktop)](https://www.docker.com/products/docker-desktop) installed and running

## Configuration

The configuration of the script consists of the variables in the beginning of [the file](../QuickDeploy.ps1). The default configuration is fine, but note that you may want to change [the location (region)](https://azure.microsoft.com/en-us/global-infrastructure/geographies/) where the resources will be deployed - the default value in the file is "`westeurope`":

```ps1
# Location (region) for all resources created
$Location = "westeurope"
```

By default the script will create a resource group named "`storage-av-demo-rg`" and prefix all resources with "`storageavdemo`" followed by a very simple hash based on the Azure user object ID to avoid collisions (some resource names need to be unique on global/local scale).

The default configuration does not contain valid Outlook settings for sending notifications. The solution will detect and remove malware, but will not send notifications without valid configuration.

## Deployment steps

1. Launch PowerShell
1. [Sign in with Azure CLI](https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli)
    * Make sure you are signed in with the account you are planning to use to deploy the solution with
1. Run the quickstart script:

    ```ps1
    .\QuickDeploy.ps1
    ```

    > **Note:** The script will output secrets so be careful not to share the output publically. You can stream the output to a file with command:
    >
    > ```ps1
    > .\QuickDeploy.ps1 > deployment.log
    > ```

See [troubleshooting section](./troubleshooting.md) in case of problems.

## Testing the solution

See separate page: [Testing the solution](./testing-solution.md)

## Clean up

### Delete resource group

Deleting the resource group will delete all the resources. To delete the resource group:

* Run Azure CLI command:

    ```plaintext
    az group delete --name storage-av-demo-rg
    ````

    OR

* [Delete in Azure Portal](https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-portal#delete-resource-groups)

### Delete service principal

1. Navigate to Azure Portal and locate **App registrations** of **Azure Active Directory**
    * See here how: [How to manage service principals](https://docs.microsoft.com/en-us/azure/developer/python/how-to-manage-service-principals)
1. Select the service principal created by the quickstart script (with default configuration the name starts with "`storageavdemo`")
1. Click **Delete** and **Yes** to confirm
