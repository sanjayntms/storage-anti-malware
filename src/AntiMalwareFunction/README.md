# Anti-malware function

This Azure Function is triggered when a new or changed blob is detected in a storage account. The function will then scan the blob using [nClam ClamAV client](https://github.com/tekmaven/nClam) and if malware is detected, delete the blob and send a notification.

## Configuration

The function requres the following environment variables to operate:

| Name | Value | Type | Example |
| ---- | ----- | ---- | ------- |
| `AzureWebJobsStorage` | The connection string of the storage account for the function app | string | `"DefaultEndpointsProtocol=https;...;EndpointSuffix=core.windows.net"` |
| `ClamAVServer` | The server running the ClamAV Docker image | string | `"storageavdemoavaci.westeurope.azurecontainer.io"` |
| `ClamAVPort` | The ClamAV server port | string | `"3310"` |
| `DataLakeAccountName` | The name of the Data Lake account | string | `"storageavdemoavafsa"` |
| `DataLakeAccountKey` | The account key of the Data Lake account | string | `"zWtayD/pifxHN9Rf+0O.....5UsgYS2LH39OfANQ=="` |
| `DataLakeConnectionString` | The connection string of the storage account to monitor (Data Lake) | string | `"DefaultEndpointsProtocol=https;...;EndpointSuffix=core.windows.net"` |
| `DataLakeServiceEndpoint` | The Data Lake service endpoint | string | `"https://storageavdemoavafsa.dfs.core.windows.net"` |
| `StorageContainerName` | The name of the storage container (to monitor) | string | `"testcontainer"` |
| `SMTPServer` | SMTP server address | string | `"smtp.office365.com"` |
| `SMTPPort` | SMTP server port | string | `"587"` |
| `SMTPDomain` | Domain for the SMTP credentials (optional) | string | `"outlook.com"` |
| `SMTPUsername` | Username for SMTP server credentials | string | `"overlook.hotel.it@outlook.com"` |
| `SMTPPassword` | Password for the SMTP server | string | |
| `NotificationSender` | The email address of the notification sender | string | `"overlook.hotel.it@outlook.com"` |
| `NotificationRecipients` | A comma separated list of notification recipient email addresses | string | `"dick.hallorann@overlookhotel.com,jack.torrance@overlookhotel.com"` |

For running and testing locally, the configuration above can be inserted in `local.settings.json` file (in the same folder as the project file (`AntiMalwareFunction.csproj`)). The content of the settings file is expected to be as follows:

```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "DefaultEndpointsProtocol=https;AccountName=***;AccountKey=***;EndpointSuffix=core.windows.net",
    "FUNCTIONS_WORKER_RUNTIME": "dotnet",
    "ClamAVServer": "storageavdemoavaci.westeurope.azurecontainer.io",
    "ClamAVPort": "3310",
    "DataLakeAccountName": "storageavdemoavafsa",
    "DataLakeAccountKey": "zWtayD/pifxHN9Rf+0O.....5UsgYS2LH39OfANQ==",
    "DataLakeConnectionString": "DefaultEndpointsProtocol=https;AccountName=***;AccountKey=***;EndpointSuffix=core.windows.net",
    "DataLakeServiceEndpoint": "https://storageavdemoavafsa.dfs.core.windows.net",
    "StorageContainerName": "testcontainer",
    "SMTPServer": "smtp.office365.com",
    "SMTPPort": "587",
    "SMTPDomain": "outlook.com",
    "SMTPUsername": "overlook.hotel.it@outlook.com",
    "SMTPPassword": "correcthorsebatterystaple",
    "NotificationSender": "overlook.hotel.it@outlook.com",
    "NotificationRecipients": "dick.hallorann@overlookhotel.com,jack.torrance@overlookhotel.com"
  }
}
```
