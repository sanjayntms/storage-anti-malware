# Creates Azure Container Instances resource for the ClamAV image.
#
---
parameters:
  - name: serviceConnectionName
    type: string
  - name: subscriptionId
    type: string
  - name: resourceGroupName
    type: string
  - name: location
    default: westeurope
    type: string
  - name: keyVaultName
    type: string
  - name: containerRegistryName
    type: string
  - name: containerGroupName
    type: string
  - name: dnsNameLabel
    type: string
  - name: clamAVContainerImage
    type: string

steps:
  - task: AzureResourceManagerTemplateDeployment@3
    displayName: Create Malware Detection Container Instances
    inputs:
      deploymentScope: "Resource Group"
      azureResourceManagerConnection: ${{ parameters.serviceConnectionName }}
      subscriptionId: ${{ parameters.subscriptionId }}
      action: "Create Or Update Resource Group"
      resourceGroupName: ${{ parameters.resourceGroupName }}
      location: ${{ parameters.location }}
      templateLocation: "Linked artifact"
      csmFile: "./arm-templates/aci_antimalware.json"
      csmParametersFile: "./arm-templates/aci_antimalware.parameters.json"
      overrideParameters: >
        -containerRegistryName ${{ parameters.containerRegistryName }}
        -containerGroupName ${{ parameters.containerGroupName }}
        -location ${{ parameters.location }}
        -dnsNameLabel ${{ parameters.dnsNameLabel }}
        -clamAVContainerImage ${{ parameters.clamAVContainerImage }}
      deploymentMode: "Incremental"
